---
layout: post
title: MS17-010 EXP 分析 && modify 

---

## 0x01  前言

内网打Ms17-010比较常见，一般走代理proxychains打正向payload

windows/x64/meterpreter/bind_tcp

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211112173233.png)

经过测试，在不开启360横向渗透防护情况下msf还是会被拦截，也就是我们大家常见的这种场景是会被拦截的

这里先说明下，正常安装360的情况下，一般是不会开启360横向渗透防护的，这个模块一般需要自己手动去添加。

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211115092540.png)

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211112173749.png)

## 0x02 乱杀

防护开的比较全的情况下，就开始乱杀了，send smb可以把工具传上去，但是执行命令还是被横向渗透防护拦截，

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211115104253.png)

测试时候发现，如果源IP不是当前Ip的话，就会被拦截远程攻击，判断攻击方式后查看源代码发现攻击利用的是老impacket包里面的psexec模块，攻击利用方式还是以起服务的方式, 拦截的主要地方是psexec起服务的地方，360这个横向渗透模块拦截了大部分的功能

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211115104536.png)

测试wmihacker查看横向是否拦截，发现360横向渗透防护并不拦截，查看源代码发现wimihacker主要是使用Win32_Process换成win32_schedulejob

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211115104356.png)

## 0x03 分析

整个的代码逻辑就是两个组合漏洞的利用，首先要能匿名访问机器的管道，并且获取到管道的名称，大致是一下几个browser，spoolss，netlogon，lasrpc , samr

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211117115311.png)

有些机器访问可能需要身份验证，比如在某些环境中，我们需要一个普通用户，或者在能直接访问匿名管道的机器上配置代理，比如下图我们访问需要输入凭据，这种凭据我们也可以通过爆破的方式获取

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211117115541.png)



跟踪代码查看是如何创建服务的，调用了CreateService的api

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211115141245.png)

打开OpenSVCManager，打开服务后获取lpServiceHandle，下面resp里面在写入CreateService的句柄

```python
resp = scmr.hRCreateServiceW(rpcsvc, svcHandle, service_name + '\x00', service_name + '\x00', lpBinaryPathName=cmd + '\x00')
```

我们仿照他的思路改即可，继续往下看代码，就是移除服务的功能，这个就是Psexec的原版功能，他在执行后会删除刚才创建过的服务，这个地方其实也是一个比较会被拦截的地方。

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211117114259.png)

## 0x04 修改

![](https://gitee.com/a4m1n/tuchuang/raw/master/pic/20211115140742.png)

